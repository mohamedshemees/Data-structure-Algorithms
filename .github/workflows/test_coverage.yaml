name: Enhanced CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - run: chmod +x gradlew
      
      - name: Run coverage checks
        run: |
          ./gradlew clean test jacocoTestReport
          COVERAGE=$(awk -F'[><]' '
            /<counter type="LINE"/ { 
              if ($3+$5 > 0) printf "%.1f", ($3/($3+$5)*100)
              else { print "0"; exit 1 }
            }' build/reports/jacoco/test/jacocoTestReport.xml)
          
          echo "COVERAGE=${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          [ $(echo "$COVERAGE >= 80" | bc) -eq 1 ] || exit 1

      - name: Post coverage summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const coverage = fs.readFileSync(
              'build/reports/jacoco/test/jacocoTestReport.xml', 'utf8'
            );
            const match = coverage.match(
              /<counter type="LINE" missed="(\d+)" covered="(\d+)"/
            );
            const percent = (match[2]/(match[1]+match[2])*100).toFixed(1);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                '### üõ†Ô∏è Custom Coverage Report',
                '| Metric       | Coverage | Status  |',
                '|--------------|----------|---------|',
                `| **Lines**    | ${percent}% | ${percent >= 80 ? '‚úÖ' : '‚ùå'} |`,
                '| **Required** | 80%      |         |',
                '',
                percent < 80 ? 'üîß *Tip*: Run `./gradlew jacocoTestReport` locally to investigate' : ''
              ].join('\n')
            });
