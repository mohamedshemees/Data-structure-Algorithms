name: Test Coverage
on:
  pull_request:
    branches: [ main ]

jobs:
  coverage-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          
      # Core coverage check (blocks merge if <80%)
      - name: Enforce coverage
        run: |
          ./gradlew clean test jacocoTestCoverageVerification
          COVERAGE=$(awk -F'[><]' '
            /<counter type="LINE"/ { cov=$3; total=$3+$5; print int(cov/total*100) }' 
            build/reports/jacoco/test/jacocoTestReport.xml)
          
          if [ $COVERAGE -lt 80 ]; then
            echo "‚ùå Coverage $COVERAGE% < 80% minimum"
            exit 1
          fi

      # PR Comment with Coverage Badge
      - name: Post coverage report
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const coverage = fs.readFileSync('build/reports/jacoco/test/jacocoTestReport.xml', 'utf8');
            const match = coverage.match(/<counter type="LINE" missed="(\d+)" covered="(\d+)"/);
            const percent = (match[2] / (match[1] + match[2]) * 100).toFixed(2);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### üìä Test Coverage Report
| Metric       | Coverage | Status  |
|--------------|----------|---------|
| **Lines**    | ${percent}% | ${percent >= 80 ? '‚úÖ' : '‚ùå'} |
| **Required** | 80%      |         |

${percent < 80 ? '‚ö†Ô∏è **Merge blocked**: Coverage too low' : '‚úîÔ∏è Ready to merge!'}`
            });

      # Upload full report (always)
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: build/reports/jacoco/test/html/
